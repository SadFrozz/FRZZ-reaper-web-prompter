<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Интерактивный текстовый монитор</title>
    <link rel="stylesheet" href="style.css">
    <script src="jquery.min.js"></script>
    <link rel="stylesheet" type="text/css" href="spectrum.css">
</head>
<body>
    <div class="container">
        
        <div id="navigation-panel" class="bottom-panel">
            <div class="panel-header">
                <h1>Интерактивный текстовый монитор</h1>
                <div id="status-indicator">Инициализация...</div>
            </div>
            
            <div class="panel-controls">
                <div class="controls-left">
                    <button type="button" id="track-selector-toggle" class="track-selector-toggle" aria-controls="track-selector" aria-haspopup="listbox" aria-expanded="false" title="Выбрать дорожку">
                        <svg class="icon-svg track-selector-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="icons.svg#icon-track" xlink:href="icons.svg#icon-track"></use></svg>
                        <span class="visually-hidden">Дорожка</span>
                    </button>
                    <div class="collapsible-select-wrapper track-selector-wrapper is-collapsed" id="track-selector-wrapper" aria-hidden="true">
                        <select id="track-selector" aria-label="Дорожка"></select>
                    </div>
                    <button type="button" id="segment-selector-toggle" class="segment-selector-toggle is-hidden" aria-controls="segment-selector" aria-haspopup="listbox" aria-expanded="false" aria-hidden="true" title="Выбрать сегмент" aria-label="Выбрать сегмент">
                        <svg class="icon-svg segment-selector-icon" viewBox="0 0 24 24" aria-hidden="true"><use href="icons.svg#icon-segment" xlink:href="icons.svg#icon-segment"></use></svg>
                        <span class="visually-hidden">Сегмент</span>
                    </button>
                    <div class="collapsible-select-wrapper segment-selector-wrapper is-collapsed" id="segment-selector-wrapper" aria-hidden="true">
                        <select id="segment-selector" aria-label="Сегмент"></select>
                    </div>
                    <button id="refresh-button" title="Обновить список дорожек">
                        <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor"><use href="icons.svg#icon-refresh" xlink:href="icons.svg#icon-refresh"></use></svg>
                    </button>
                </div>
                
                <div id="transport-status">
                    <div id="transport-icon-container">
                        <svg id="icon-play" class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-play" xlink:href="icons.svg#icon-play"></use></svg>
                        <svg id="icon-stop" class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-stop" xlink:href="icons.svg#icon-stop"></use></svg>
                        <svg id="icon-record" class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-record" xlink:href="icons.svg#icon-record"></use></svg>
                    </div>
                    <span id="transport-state-text">Стоп</span>
                    <span id="transport-timecode">00:00:00:00</span>
                    <div id="transport-progress-container" aria-hidden="true">
                        <div id="transport-progress-bar"></div>
                    </div>
                </div>
                
                <div class="controls-right">
                    <button id="navigation-compact-toggle" title="Свернуть панель" aria-label="Свернуть панель" aria-expanded="true">
                        <svg class="icon-svg icon-collapse" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-chevron-down" xlink:href="icons.svg#icon-chevron-down"></use></svg>
                        <svg class="icon-svg icon-expand" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-chevron-up" xlink:href="icons.svg#icon-chevron-up"></use></svg>
                    </button>
                    <button id="navigation-fullscreen-toggle" title="На весь экран" aria-label="На весь экран" aria-pressed="false">
                        <svg class="icon-svg icon-enter" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-fullscreen-enter" xlink:href="icons.svg#icon-fullscreen-enter"></use></svg>
                        <svg class="icon-svg icon-exit" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-fullscreen-exit" xlink:href="icons.svg#icon-fullscreen-exit"></use></svg>
                    </button>
                    <button id="project-settings-button" title="Настройки проекта" aria-label="Настройки проекта" style="display:none;" aria-hidden="true">
                        <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-project-settings" xlink:href="icons.svg#icon-project-settings"></use></svg>
                    </button>
                    <!-- Actors coloring button placed BEFORE stats/settings -->
                    <button id="actors-button" title="Раскраска актёров (цвета)">
                        <!-- Brush icon (geometry preserved) -->
                        <svg class="icon-svg" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-actors" xlink:href="icons.svg#icon-actors"></use></svg>
                    </button>
                    <button id="stats-button" title="Статистика" style="display:none;">
                        <!-- Stats icon centered -->
                        <svg class="icon-svg" viewBox="0 0 32 32" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-stats" xlink:href="icons.svg#icon-stats"></use></svg>
                    </button>
                    <button id="settings-button" title="Настройки">
                        <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor"><use href="icons.svg#icon-settings" xlink:href="icons.svg#icon-settings"></use></svg>
                    </button>
                </div>
            </div>
        </div>

        <div id="navigation-floating-controls" class="navigation-floating-controls" aria-hidden="true">
            <button id="navigation-floating-expand" type="button" title="Развернуть панель" aria-label="Развернуть панель">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-chevron-up" xlink:href="icons.svg#icon-chevron-up"></use></svg>
            </button>
            <button id="navigation-floating-fullscreen" type="button" title="На весь экран" aria-label="На весь экран" aria-pressed="false">
                <svg class="icon-svg icon-enter" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-fullscreen-enter" xlink:href="icons.svg#icon-fullscreen-enter"></use></svg>
                <svg class="icon-svg icon-exit" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-fullscreen-exit" xlink:href="icons.svg#icon-fullscreen-exit"></use></svg>
            </button>
            <button id="navigation-floating-settings" type="button" title="Настройки" aria-label="Настройки">
                <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><use href="icons.svg#icon-settings" xlink:href="icons.svg#icon-settings"></use></svg>
            </button>
        </div>

        <main>
            <div id="text-display-wrapper">
                <div id="text-display">
                    <p>Загрузка текста...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="debug-log-modal" class="modal" aria-hidden="true">
        <div class="modal-content modal-debug-log">
            <button type="button" class="modal-close-button" aria-label="Закрыть журнал">&times;</button>
            <h2>Журнал событий</h2>
            <div id="debug-log-area" class="debug-log-area" role="log" aria-live="polite" aria-relevant="additions text">
                <div id="debug-log-empty" class="debug-log-empty">Сообщений пока нет. Новые записи появятся здесь.</div>
                <div id="debug-log-entries" class="debug-log-entries"></div>
            </div>
            <div class="debug-log-actions">
                <button type="button" id="debug-log-save" class="button-secondary">Сохранить лог</button>
                <button type="button" id="debug-log-copy" class="button-secondary">Скопировать лог</button>
                <button type="button" id="debug-log-clear" class="button-secondary">Очистить журнал</button>
            </div>
        </div>
    </div>

    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button">&times;</span>
            <h2>Настройки</h2>
            <div class="settings-body">
                <fieldset class="fieldset-collapsible expanded">
                    <legend>Взаимодействие с ролями</legend>
                    <div class="settings-tile-grid role-settings-tiles">
                        <div class="settings-tile role-settings-tile" id="process-roles-tile">
                            <div class="setting-item">
                                <label for="process-roles">Включить обработку</label>
                                <input type="checkbox" id="process-roles">
                            </div>
                        </div>
                        <div class="role-options-wrapper is-hidden" id="role-options-wrapper">
                            <div class="settings-tile role-settings-tile" id="role-display-style-tile">
                                <div class="setting-item" style="display: contents;">
                                    <label for="role-display-style">Стиль отображения роли</label>
                                    <select id="role-display-style" style="max-width: 100%;">
                                        <option value="column_with_swatch">В колонке с ярлыком цвета</option>
                                        <option value="column">В отдельной колонке</option>
                                        <option value="inline">В тексте реплики</option>
                                        <option value="hidden">Скрыть роль</option>
                                    </select>
                                </div>
                                <div class="setting-item">
                                    <label for="enable-color-swatches">Включить окраску блоков</label>
                                    <input type="checkbox" id="enable-color-swatches">
                                </div>
                                <div class="setting-item">
                                    <label for="role-font-color-enabled" title="Если включено, фон роли будет осветляться для обеспечения контраста с черным текстом. Если выключено, цвет текста будет подбираться автоматически.">Осветлять ярлык роли под черный шрифт</label>
                                    <input type="checkbox" id="role-font-color-enabled">
                                </div>
                                <div class="setting-item">
                                    <label for="ignore-project-item-colors">Игнорировать цвета проекта</label>
                                    <input type="checkbox" id="ignore-project-item-colors" checked>
                                </div>
                            </div>
                            <div class="settings-tile role-settings-tile" id="role-behavior-tile">
                                <div class="setting-item">
                                    <label for="deduplicate-roles">Скрывать повтор роли</label>
                                    <input type="checkbox" id="deduplicate-roles">
                                </div>
                                <div class="setting-item">
                                    <label for="auto-hide-empty-column">Автоматически скрывать пустую колонку</label>
                                    <input type="checkbox" id="auto-hide-empty-column">
                                </div>
                            </div>
                            <div class="settings-tile role-settings-tile settings-tile-slider" id="role-filter-mode-tile">
                                <div class="setting-item">
                                    <label for="filter-hidden-behavior">Скрытые роли/актёры</label>
                                    <select id="filter-hidden-behavior">
                                        <option value="hide">Скрывать</option>
                                        <option value="dim">Затемнять</option>
                                    </select>
                                </div>
                                <div id="filter-dim-percent-wrapper" class="filter-dim-controls is-hidden">
                                    <label class="settings-tile-title" for="filter-dim-percent">Процент затемнения</label>
                                    <div class="settings-slider-row">
                                        <input type="range" id="filter-dim-percent" class="frzz-slider" min="10" max="90" step="1">
                                        <span id="filter-dim-percent-value" class="settings-slider-value">60%</span>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-tile role-settings-tile" id="role-layout-tile">
                                <div class="setting-item">
                                    <label for="swap-columns">Поменять колонки местами</label>
                                    <input type="checkbox" id="swap-columns">
                                </div>
                            </div>
                            <div class="settings-tile role-settings-tile settings-tile-slider" id="role-scale-tile">
                                <label class="settings-tile-title" for="role-column-scale">Масштаб колонки</label>
                                <div class="settings-slider-row" id="role-column-scale-wrapper">
                                    <input type="range" id="role-column-scale" class="frzz-slider" min="50" max="200" step="25">
                                    <span id="role-column-scale-value" class="settings-slider-value">100%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="fieldset-collapsible expanded">
                    <legend>Шахматная раскраска</legend>
                    <div class="settings-tile-grid checkerboard-settings-tiles">
                        <div class="settings-tile checkerboard-settings-tile" id="checkerboard-toggle-tile">
                            <div class="setting-item">
                                <label for="checkerboard-enabled">Включить</label>
                                <input type="checkbox" id="checkerboard-enabled">
                            </div>
                        </div>
                        <div class="checkerboard-options-wrapper is-hidden" id="checkerboard-options-wrapper">
                            <div class="settings-tile checkerboard-settings-tile" id="checkerboard-mode-tile">
                                <div class="setting-item">
                                    <label for="checkerboard-mode">Режим</label>
                                    <select id="checkerboard-mode">
                                        <option value="unconditional">Безусловно</option>
                                        <option value="by_role">Следить за ролями</option>
                                        <option value="by_color">Следить за цветами</option>
                                    </select>
                                </div>
                            </div>
                            <div class="settings-tile checkerboard-settings-tile" id="checkerboard-backgrounds-tile">
                                <div class="checkerboard-pair-row wrap setting-group-inline-colors">
                                    <div class="setting-item responsive">
                                        <label for="checkerboard-bg1">Фон 1</label>
                                        <div class="input-with-button">
                                            <input type="text" id="checkerboard-bg1" value="rgba(34,34,34,1)">
                                            <button class="copy-color-btn" title="Копировать цвет"><svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-tile checkerboard-settings-tile" id="checkerboard-backgrounds-tile">
                                <div class="checkerboard-pair-row wrap setting-group-inline-colors">
                                    <div class="setting-item responsive">
                                        <label for="checkerboard-bg2">Фон 2</label>
                                        <div class="input-with-button">
                                            <input type="text" id="checkerboard-bg2" value="rgba(42,42,42,1)">
                                            <button class="copy-color-btn" title="Копировать цвет"><svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-tile checkerboard-settings-tile" id="checkerboard-fonts-tile">
                                <div class="checkerboard-pair-row wrap  setting-group-inline-colors">
                                    <div class="setting-item responsive">
                                        <label for="checkerboard-font1">Шрифт 1</label>
                                        <div class="input-with-button">
                                            <input type="text" id="checkerboard-font2" value="rgba(238,238,238,1)">
                                            <button class="copy-color-btn" title="Копировать цвет"><svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="settings-tile checkerboard-settings-tile" id="checkerboard-backgrounds-tile">
                                <div class="checkerboard-pair-row wrap setting-group-inline-colors">
                                    <div class="setting-item responsive">
                                        <label for="checkerboard-font2">Шрифт 2</label>
                                        <div class="input-with-button">
                                            <input type="text" id="checkerboard-font1" value="rgba(238,238,238,1)">
                                            <button class="copy-color-btn" title="Копировать цвет"><svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="fieldset-collapsible expanded" id="segmentation-settings-fieldset">
                    <legend>Сегментирование</legend>
                    <div class="settings-tile-grid segmentation-settings-tiles">
                            <div class="settings-tile" id="segmentation-manual-tile">
                                <div class="setting-item">
                                    <label for="segmentation-manual-enabled">Ручной режим</label>
                                    <input type="checkbox" id="segmentation-manual-enabled">
                                </div>
                                <div class="setting-item">
                                    <label for="manual-segment-default-duration-minutes">Длительность сегмента по умолчанию (минуты)</label>
                                    <input type="number" id="manual-segment-default-duration-minutes" min="1" value="60">
                                </div>
                                <p class="settings-helper-text">При наличии ручных сегментов они заменяют автоопределение.</p>
                            </div>
                        <div class="settings-tile" id="segmentation-autodetect-tile">
                            <div class="setting-item-vertical">
                                <label for="segmentation-autodetect-mode">Автоопределение</label>
                                <select id="segmentation-autodetect-mode" aria-label="Автоопределение">
                                    <option value="none">Выключить</option>
                                    <option value="video">Только по видеофайлам</option>
                                    <option value="markers">Только по маркерам\регионам</option>
                                    <option value="both">Двойной режим</option>
                                </select>
                            </div>
                            <div class="setting-item-vertical" id="segmentation-video-keywords-wrapper">
                                <label for="segmentation-auto-video-keywords">Название дорожки для автопоиска</label>
                                <input type="text" id="segmentation-auto-video-keywords" value="ВИДЕО, ВИДОС, ВИДОСЫ, VID, VIDEO, RAW, РАВКА">
                            </div>
                            <div class="setting-item-vertical" id="segmentation-marker-pattern-wrapper">
                                <label for="segmentation-marker-pattern">Шаблон</label>
                                <input type="text" id="segmentation-marker-pattern" value="$N (сери*|эпизод*|част*)" title="$N - позиция числа; звёздочка дополняет окончание слова. Примеры совпадений: '13 серия', '8 часть', '102 эпизод'.">
                            </div>
                            <div class="setting-item" id="segmentation-priority-wrapper">
                                <label for="segmentation-autodetect-priority">Приоритет</label>
                                <select id="segmentation-autodetect-priority">
                                    <option value="video">По видеофайлам</option>
                                    <option value="markers">По маркерам\регионам</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-tile" id="segmentation-display-tile">
                            <div class="settings-tile-title">Отображение субтитров</div>
                            <div class="setting-item">
                                <label for="segmentation-display-mode">Режим</label>
                                <select id="segmentation-display-mode">
                                    <option value="current">Текущий сегмент</option>
                                    <option value="all">Все сегменты</option>
                                </select>
                            </div>
                            <div class="setting-item" id="segmentation-auto-switch-wrapper">
                                <label for="segmentation-auto-switch-mode">Автосмена сегмента</label>
                                <select id="segmentation-auto-switch-mode">
                                    <option value="playback_only">Только при воспроизведении</option>
                                    <option value="always">Всегда</option>
                                    <option value="disabled">Выключить</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </fieldset>
                
                <fieldset class="fieldset-collapsible expanded">
                    <legend>Подсветка</legend>
                    <div class="settings-tile-grid highlight-settings-tiles">
                        <div class="settings-tile highlight-settings-tile" id="highlight-current-tile">
                            <div class="setting-item mini">
                                <label for="highlight-current-enabled">Текущая реплика</label>
                                <input type="checkbox" id="highlight-current-enabled">
                            </div>
                            <div id="highlight-current-options" class="setting-inline-row setting-group-inline-colors">
                                <div class="setting-item mini">
                                    <label for="highlight-current-bg">Цвет подсветки</label>
                                    <div class="input-with-button">
                                        <input type="text" id="highlight-current-bg" value="rgba(80, 80, 0, 0.4)">
                                        <button class="copy-color-btn" title="Копировать цвет">
                                            <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile highlight-settings-tile" id="highlight-previous-tile">
                            <div class="setting-item mini">
                                <label for="highlight-current-role-enabled">Подсвечивать фон роли</label>
                                <input type="checkbox" id="highlight-current-role-enabled">
                            </div>
                            <div class="setting-item mini" id="highlight-role-color-wrapper" style="display: none;">
                                <label for="highlight-current-role-bg">Цвет подсветки</label>
                                <div class="input-with-button">
                                    <input type="text" id="highlight-current-role-bg" value="rgba(80, 80, 0, 0.4)">
                                    <button class="copy-color-btn" title="Копировать цвет">
                                        <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile highlight-settings-tile" id="highlight-previous-tile">
                            <div class="setting-item">
                                <label for="highlight-previous-enabled">Прошлая реплика</label>
                                <input type="checkbox" id="highlight-previous-enabled">
                            </div>
                            <div id="highlight-previous-options" class="setting-inline-row setting-group-inline-colors">
                                <div class="setting-item mini">
                                    <label for="highlight-pause-enabled">В паузах между репликами</label>
                                    <input type="checkbox" id="highlight-pause-enabled">
                                </div>
                                <div class="setting-item mini">
                                    <label for="highlight-pause-bg">Цвет подсветки</label>
                                    <div class="input-with-button">
                                        <input type="text" id="highlight-pause-bg" value="rgba(0, 80, 120, 0.3)">
                                        <button class="copy-color-btn" title="Копировать цвет">
                                            <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile highlight-settings-tile" id="highlight-progress-tile">
                            <div class="setting-item">
                                <label for="progress-bar-enabled">Прогресс-бар</label>
                                <input type="checkbox" id="progress-bar-enabled">
                            </div>
                            <div id="highlight-progress-options" class="setting-inline-row setting-group-inline-colors">
                                <div class="setting-item mini" id="progress-bar-mode-wrapper" style="display:none;">
                                    <label for="progress-bar-mode">Положение</label>
                                    <select id="progress-bar-mode">
                                        <option value="subtitle">Под репликой</option>
                                        <option value="timecode">Под таймкодом</option>
                                    </select>
                                </div>
                                <div class="setting-item mini">
                                    <label for="progress-bar-color">Цвет</label>
                                    <div class="input-with-button">
                                        <input type="text" id="progress-bar-color" value="rgba(255,193,7,1)">
                                        <button class="copy-color-btn" title="Копировать цвет">
                                            <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile highlight-settings-tile" id="highlight-click-tile">
                            <div class="setting-item">
                                <label for="highlight-click-enabled">По клику на таймкод</label>
                                <input type="checkbox" id="highlight-click-enabled" aria-label="Включить подсветку по клику">
                            </div>
                            <div id="highlight-click-options-wrapper" class="setting-inline-row setting-group-inline-colors">
                                <div class="setting-item mini">
                                    <label for="highlight-click-bg">Цвет подсветки</label>
                                    <div class="input-with-button">
                                        <input type="text" id="highlight-click-bg" value="rgba(120, 0, 120, 0.4)">
                                        <button class="copy-color-btn" title="Копировать цвет">
                                            <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                        </button>
                                    </div>
                                </div>
                                <div class="setting-item mini">
                                    <label for="highlight-click-duration">Длительность (мс)</label>
                                    <input type="number" id="highlight-click-duration" class="short-input" value="800" min="50" max="60000" step="50">
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile highlight-settings-tile" id="highlight-overlap-tile">
                            <div class="setting-item">
                                <label for="highlight-overlap-enabled">Показывать пересечения</label>
                                <input type="checkbox" id="highlight-overlap-enabled">
                            </div>
                            <div id="highlight-overlap-options" class="setting-inline-row setting-group-inline-colors">
                                <div class="setting-item mini">
                                    <label for="highlight-overlap-color">Цвет обводки</label>
                                    <div class="input-with-button">
                                        <input type="text" id="highlight-overlap-color" value="rgba(255, 112, 67, 0.75)">
                                        <button class="copy-color-btn" title="Копировать цвет">
                                            <svg class="icon-svg" viewBox="0 0 24 24"><use href="icons.svg#icon-copy" xlink:href="icons.svg#icon-copy"></use></svg>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="fieldset-collapsible expanded">
                    <legend>Автопрокрутка</legend>
                    <div class="setting-item">
                        <label for="auto-scroll">Включить</label>
                        <input type="checkbox" id="auto-scroll">
                    </div>
                    <div id="auto-scroll-settings-wrapper" class="settings-tile-grid" style="display:none;">
                        <div class="settings-tile" id="auto-scroll-mode-card">
                            <label class="settings-tile-title" for="auto-scroll-mode">Режим автоскролла</label>
                            <select id="auto-scroll-mode">
                                <option value="page">Постраничный</option>
                                <option value="line">Построчный</option>
                            </select>
                        </div>
                        <div class="settings-tile settings-tile-slider" id="scroll-speed-wrapper">
                            <label class="settings-tile-title" for="scroll-speed">Скорость прокрутки</label>
                            <div class="settings-slider-row">
                                <input type="range" id="scroll-speed" class="frzz-slider" min="0" max="21" step="1">
                                <span id="scroll-speed-value" class="settings-slider-value">60%</span>
                            </div>
                            <p id="scroll-speed-caption" class="scroll-caption settings-slider-caption"></p>
                        </div>
                        <div class="settings-tile" id="auto-scroll-dynamic-speed-tile">
                            <div class="setting-item">
                                <label for="auto-scroll-dynamic-speed-enabled">Динамическая скорость</label>
                                <input type="checkbox" id="auto-scroll-dynamic-speed-enabled" checked>
                            </div>
                            <p class="settings-helper-text">При отключении используется фиксированная длительность прокрутки.</p>
                        </div>
                        <div class="settings-tile settings-tile-slider" id="auto-scroll-line-anchor-wrapper" style="display:none;">
                            <label class="settings-tile-title" for="auto-scroll-line-anchor-percent">Позиция строки (%)</label>
                            <div class="settings-slider-row">
                                <input type="range" id="auto-scroll-line-anchor-percent" class="frzz-slider" min="0" max="100" step="1" value="35">
                                <span id="auto-scroll-line-anchor-value" class="settings-slider-value">35%</span>
                            </div>
                        </div>
                        <div class="settings-tile" id="auto-scroll-window-wrapper">
                            <label class="settings-tile-title">Границы прокрутки (%)</label>
                            <div class="setting-range with-side-values">
                                <span id="auto-scroll-window-top-value">10%</span>
                                <div class="dual-range" id="auto-scroll-window-range">
                                    <div class="dual-range-track" id="auto-scroll-window-track"></div>
                                    <input type="range" id="auto-scroll-window-top-percent" min="0" max="100" step="1" value="10">
                                    <input type="range" id="auto-scroll-window-bottom-percent" min="0" max="100" step="1" value="85">
                                </div>
                                <span id="auto-scroll-window-bottom-value">85%</span>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset class="fieldset-collapsible expanded">
                    <legend>Общие настройки</legend>
                    <div id="general-settings-tiles" class="settings-tile-grid general-settings-tiles">
                        <div class="settings-tile general-settings-tile" id="general-title-tile">
                            <div class="setting-item">
                                <label for="title-mode">Заголовок</label>
                                <select id="title-mode">
                                    <option value="placeholder" selected>Показывать заглушку</option>
                                    <option value="project_name">Показывать название проекта</option>
                                    <option value="custom_text">Показывать свой текст</option>
                                    <option value="none">Ничего не показывать</option>
                                </select>
                            </div>
                            <div class="setting-item" id="custom-title-wrapper">
                                <label for="custom-title-text">Свой текст заголовка</label>
                                <input type="text" id="custom-title-text">
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile" id="general-layout-tile">
                            <label>Навигационная панель</label>
                            <div class="setting-item">
                                <label for="navigation-panel-position">Разместить сверху</label>
                                <input type="checkbox" id="navigation-panel-position">
                            </div>
                            <div class="setting-item">
                                <label for="navigation-compact-mode">Компактный вид</label>
                                <input type="checkbox" id="navigation-compact-mode">
                            </div>
                            <div class="setting-item">
                                <label for="transport-timecode-visible">Показывать статус транспорта и таймкод</label>
                                <input type="checkbox" id="transport-timecode-visible">
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile" id="general-jump-tile">
                            <div class="setting-item">
                                <label for="timecode-display-format">Формат таймкода</label>
                                <select id="timecode-display-format">
                                    <option value="auto" selected>Авто (по FPS)</option>
                                    <option value="frames">HH:MM:SS:FF</option>
                                    <option value="milliseconds">HH:MM:SS.ms</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile" id="general-jump-tile">
                            <div class="setting-group">
                                <div class="setting-group-header-flex">
                                    <p class="setting-group-title">Прыжок по клику</p>
                                    <div class="inline-checkbox">
                                        <input type="checkbox" id="jump-on-click-enabled" aria-label="Включить Jump по клику">
                                    </div>
                                </div>
                                <div id="jump-settings-wrapper" style="display:none;">
                                    <div class="setting-item">
                                        <label for="jump-pre-roll-seconds">Время до реплики (сек)</label>
                                        <input type="number" id="jump-pre-roll-seconds" class="short-input" min="0" max="10" step="0.1" value="0">
                                    </div>
                                    <p class="setting-group-title">Блокировать прыжок</p>
                                    <div class="setting-inline-row">
                                        <div class="setting-item mini">
                                            <label for="jump-prevent-while-playing">При воспроизведении</label>
                                            <input type="checkbox" id="jump-prevent-while-playing" checked>
                                        </div>
                                        <div class="setting-item mini">
                                            <label for="jump-prevent-while-recording">При записи</label>
                                            <input type="checkbox" id="jump-prevent-while-recording" checked>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile" id="general-theme-tile">
                            <div class="setting-item">
                                <label for="theme-toggle">Светлая тема</label>
                                <input type="checkbox" id="theme-toggle">
                            </div>
                            <div class="setting-item">
                                <label for="auto-find-track">Автоматически искать дорожку</label>
                                <input type="checkbox" id="auto-find-track">
                            </div>
                            <div class="setting-item-vertical" id="auto-find-keywords-wrapper">
                                <label for="auto-find-keywords">Ключевые слова для автопоиска (через запятую)</label>
                                <input type="text" id="auto-find-keywords">
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile" id="general-font-tile">
                            <div class="setting-item">
                                <label for="font-family">Шрифт</label>
                                <select id="font-family">
                                    <option value="'-apple-system', BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif">Стандартный</option>
                                    <option value="'Courier New', Courier, monospace">Моноширинный (Courier)</option>
                                    <option value="'Times New Roman', Times, serif">С засечками (Times)</option>
                                    <option value="Verdana, Geneva, sans-serif">Без засечек (Verdana)</option>
                                </select>
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile settings-tile-slider" id="general-ui-scale-tile">
                            <label class="settings-tile-title" for="ui-scale">Масштаб интерфейса</label>
                            <div class="settings-slider-row">
                                <input type="range" id="ui-scale" class="frzz-slider" min="50" max="300" step="25">
                                <span id="ui-scale-value" class="settings-slider-value">100%</span>
                            </div>
                        </div>
                        <div class="settings-tile general-settings-tile settings-tile-slider" id="general-line-spacing-tile">
                            <label class="settings-tile-title" for="line-spacing">Межстрочный отступ</label>
                            <div class="settings-slider-row">
                                <input type="range" id="line-spacing" class="frzz-slider" min="0" max="400" step="10">
                                <span id="line-spacing-value" class="settings-slider-value">100%</span>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <div class="modal-footer-buttons">
                    <button id="reset-settings-button" class="button-danger">Сбросить по умолчанию</button>
                    <button id="save-settings-button">Сохранить</button>
                </div>
                <div class="modal-footer-meta" aria-hidden="true">
                    <p class="modal-footer-meta-line" id="settings-app-version">Интерактивная монтажка</p>
                    <p class="modal-footer-meta-line">2025 © Andrew "SadFrozz" Brodsky</p>
                    <p class="modal-footer-meta-line"><a href="https://github.com/SadFrozz/FRZZ-reaper-web-prompter" target="_blank" rel="noopener noreferrer">GitHub</a></p>
                </div>
            </div>
        </div>
    </div>

    <div id="project-settings-modal" class="modal" aria-hidden="true">
        <div class="modal-content">
            <span class="modal-close-button" data-close="project-settings-modal">&times;</span>
            <h2>Настройки проекта</h2>
            <div class="settings-body project-settings-body" id="project-settings-body">
                <fieldset class="project-settings-section" id="project-settings-manual-fieldset">
                    <legend>Ручное сегментирование</legend>
                    <section class="project-manual-section project-manual-current" id="project-manual-current-section" aria-live="polite">
                        <header class="project-manual-section-header">
                            <h3 class="project-manual-section-title">Текущие сегменты</h3>
                            <button type="button" class="button-secondary" id="project-manual-add-button">Добавить сегмент</button>
                        </header>
                        <div class="project-manual-table-wrapper">
                            <table class="project-manual-table" id="project-manual-table" aria-describedby="project-manual-current-empty">
                                <thead>
                                    <tr>
                                        <th scope="col" class="project-manual-col-ordinal">#</th>
                                        <th scope="col">Название сегмента</th>
                                        <th scope="col" class="project-manual-col-time">Начало (чч:мм:сс.мс)</th>
                                        <th scope="col" class="project-manual-actions-col"><span class="visually-hidden">Действия</span></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                            <div class="project-manual-empty" id="project-manual-current-empty">Сегменты, добавленные вручную, отсутствуют. Добавьте их или воспользуйтесь генератором ниже.</div>
                        </div>
                    </section>
                    <section class="project-manual-section" id="project-manual-generate-section">
                        <button type="button" class="project-manual-toggle" id="project-manual-generate-toggle" aria-expanded="false" aria-controls="project-manual-generator">
                            <span class="project-manual-toggle-label">Сгенерировать сегменты</span>
                            <svg class="icon-svg project-manual-toggle-icon" viewBox="0 0 24 24" aria-hidden="true">
                                <use href="icons.svg#icon-chevron-down" xlink:href="icons.svg#icon-chevron-down"></use>
                            </svg>
                        </button>
                        <div class="project-manual-generator is-hidden" id="project-manual-generator" aria-hidden="true">
                            <div class="project-manual-generator-grid">
                                <div class="setting-item">
                                    <label for="project-manual-start-time">Начало первого сегмента</label>
                                    <input type="text" id="project-manual-start-time" placeholder="00:00:00.000">
                                </div>
                                <div class="setting-item">
                                    <label for="project-manual-start-index">Стартовый номер</label>
                                    <input type="number" id="project-manual-start-index" min="1" value="1">
                                </div>
                                <div class="setting-item">
                                    <label for="project-manual-count">Количество</label>
                                    <input type="number" id="project-manual-count" min="1" placeholder="Авто">
                                </div>
                                <div class="setting-item project-manual-duration-row">
                                    <label for="project-manual-duration-value">Длина сегмента</label>
                                    <div class="project-manual-duration-controls">
                                        <input type="number" id="project-manual-duration-value" min="1" value="60">
                                        <select id="project-manual-duration-unit">
                                            <option value="minutes" selected>Минуты</option>
                                            <option value="hours">Часы</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="setting-item project-manual-toggle-row">
                                    <label for="project-manual-generate-names">Генерировать названия</label>
                                    <input type="checkbox" id="project-manual-generate-names" checked>
                                </div>
                                <div class="setting-item project-manual-mask-row">
                                    <div class="project-manual-mask-fields">
                                        <label for="project-manual-name-mask">Формат названия</label>
                                        <input type="text" id="project-manual-name-mask" value="$N серия">
                                    </div>
                                    <p class="settings-helper-text">Используйте $N для подстановки номера сегмента.</p>
                                </div>
                            </div>
                            <div class="project-manual-generator-actions" id="project-manual-generator-buttons">
                                <button type="button" class="button-primary project-manual-action-empty" id="project-manual-generate-button">Сгенерировать</button>
                                <button type="button" class="button-secondary project-manual-action-nonempty" id="project-manual-generate-append-button" style="display:none;">Сгенерировать дополнительные сегменты</button>
                                <button type="button" class="button-secondary project-manual-action-nonempty" id="project-manual-generate-replace-button" style="display:none;">Сгенерировать с заменой</button>
                            </div>
                        </div>
                    </section>
                    <div class="project-manual-footer-actions">
                        <button type="button" class="button-primary" id="project-manual-save-button" disabled>Сохранить сегменты</button>
                        <button type="button" class="button-secondary" id="project-manual-clear-button" disabled>Очистить сегменты</button>
                        <button type="button" class="button-danger" id="project-manual-reset-button" style="display:none;" disabled>Сбросить сегменты</button>
                    </div>
                </fieldset>
            </div>
        </div>
    </div>
    
    <div id="actors-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" data-close="actors-modal">&times;</span>
            <h2>Раскраска актёров</h2>
            <div class="settings-body">
                <fieldset>
                    <legend>Сопоставление актёр → роли</legend>
                    <div class="setting-item-vertical actor-role-mapping-group">
                        <div id="actor-role-warning" class="modal-warning" style="display:none;" role="status"></div>
                        <label for="actor-role-mapping-text">Каждая строка: АКТЁР (пробел | запятая | двоеточие) РОЛЬ1, РОЛЬ2, ...</label>
                        <textarea id="actor-role-mapping-text" rows="6" placeholder="Иванов: РОЛЬ_1, РОЛЬ_2\nПетров РОЛЬ_3, РОЛЬ_4"></textarea>
                        <div class="setting-item actor-role-import-row">
                            <button type="button" id="import-actor-role-from-project" class="button-secondary">Импортировать карту ролей из проекта</button>
                            <p id="actor-role-import-status" class="settings-helper-text" aria-live="polite"></p>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Цвета актёров</legend>
                    <div id="actor-color-list" class="actor-color-list"></div>
                    <details id="role-filter-section" class="role-filter-section">
                        <summary class="role-filter-summary">
                            <span class="role-filter-summary-leading-icon" aria-hidden="true">
                                <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor">
                                    <use href="icons.svg#icon-filter" xlink:href="icons.svg#icon-filter"></use>
                                </svg>
                            </span>
                            <span class="role-filter-summary-label">Фильтрация по ролям<span id="role-filter-count" class="role-filter-count"></span></span>
                            <span class="role-filter-summary-toggle" aria-hidden="true">
                                <svg class="role-filter-summary-toggle-icon role-filter-toggle-expand" viewBox="0 0 24 24" fill="currentColor">
                                    <use href="icons.svg#icon-chevron-down" xlink:href="icons.svg#icon-chevron-down"></use>
                                </svg>
                                <svg class="role-filter-summary-toggle-icon role-filter-toggle-collapse" viewBox="0 0 24 24" fill="currentColor">
                                    <use href="icons.svg#icon-chevron-up" xlink:href="icons.svg#icon-chevron-up"></use>
                                </svg>
                            </span>
                        </summary>
                        <div class="role-filter-chips-wrapper">
                            <div id="role-filter-chips" class="role-filter-chips" aria-live="polite"></div>
                            <button type="button" id="role-filter-reset-button" class="role-filter-reset" hidden>
                                <span class="role-filter-reset-icon" aria-hidden="true">
                                    <svg class="icon-svg" viewBox="0 0 24 24" fill="currentColor">
                                        <use href="icons.svg#icon-role-reset" xlink:href="icons.svg#icon-role-reset"></use>
                                    </svg>
                                </span>
                                <span class="role-filter-reset-label">Сбросить роли</span>
                            </button>
                        </div>
                    </details>
                </fieldset>
                <fieldset>
                    <legend>Роли без актёра</legend>
                    <div id="unassigned-roles-list" class="unassigned-roles-list" aria-live="polite"></div>
                </fieldset>
                <div class="modal-footer-buttons">
                    <button id="reset-actor-filters-button" class="button-danger">Сбросить фильтрацию</button>
                    <button id="save-actors-button">Сохранить раскраску</button>
                </div>
            </div>
        </div>
    </div>

    <div id="stats-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-button" data-close="stats-modal">&times;</span>
            <h2>Статистика</h2>
            <div class="settings-body" id="stats-body">
                <div id="stats-segmentation-controls" class="stats-segmentation-controls" style="display:none;">
                    <label for="stats-segment-select">Сегмент</label>
                    <select id="stats-segment-select"></select>
                    <span id="stats-segment-source" class="stats-segment-source"></span>
                </div>
                <div id="stats-roles-section" style="display:none;">
                    <h3>По ролям</h3>
                    <table class="stats-table" id="stats-roles-table">
                        <thead><tr><th>Роль</th><th>Кол-во</th><th>%</th></tr></thead>
                        <tbody></tbody>
                        <tfoot><tr><th>Всего</th><th id="stats-roles-total"></th><th>100%</th></tr></tfoot>
                    </table>
                </div>
                <div id="stats-actors-section" style="display:none;">
                    <h3>По актёрам</h3>
                    <table class="stats-table" id="stats-actors-table">
                        <thead><tr><th>Актёр</th><th>Кол-во</th><th>%</th></tr></thead>
                        <tbody></tbody>
                        <tfoot><tr><th>Всего</th><th id="stats-actors-total"></th><th>100%</th></tr></tfoot>
                    </table>
                </div>
                <div id="stats-colors-section" style="display:none;">
                    <h3>По цветам</h3>
                    <table class="stats-table" id="stats-colors-table">
                        <thead><tr><th>Цвет</th><th>Кол-во</th><th>%</th></tr></thead>
                        <tbody></tbody>
                        <tfoot><tr><th>Всего</th><th id="stats-colors-total"></th><th>100%</th></tr></tfoot>
                    </table>
                </div>
                <div id="stats-empty" style="display:none; opacity:0.7;">Нет данных для статистики.</div>
            </div>
        </div>
    </div>
    
    <script src="main.js"></script>
    <script src="script.js"></script>
    <script src="spectrum.js"></script>
</body>
</html>