# Интерактивный текстовый монитор для REAPER

Интерактивный текстовый монитор / телесуфлёр / монтажный лист (интерактивная монтажка) для REAPER с двумя режимами работы: встроенное окно (через расширение `reaper_webview`) и доступ по локальной сети из любого браузера.

## Оглавление
1. [Возможности](#возможности)
2. [Скриншоты / Визуал](#скриншоты--визуал)
3. [Архитектура и компоненты](#архитектура-и-компоненты)
4. [Установка](#установка)
   1. [Быстрая установка через инсталлер](#быстрая-установка-через-инсталлер)
   2. [Ручная установка](#ручная-установка)
5. [Первый запуск](#первый-запуск)
6. [Режимы использования](#режимы-использования)
   1. [Встроенный WebView внутри REAPER](#встроенный-webview-внутри-reaper)
   2. [Открытие в браузере по сети](#открытие-в-браузере-по-сети)
7. [Настройки и поведение](#настройки-и-поведение)
   1. [Основные параметры](#основные-параметры)
   2. [Цветовая модель ролей / актёров](#цветовая-модель-ролей--актёров)
   3. [Checkerboard режим](#checkerboard-режим)
8. [Структура репозитория](#структура-репозитория)
9. [Обновление](#обновление)
10. [Известные ограничения](#известные-ограничения)
11. [Roadmap (кратко)](#roadmap-кратко)
12. [Отладка и диагностика](#отладка-и-диагностика)
13. [Частые вопросы](#частые-вопросы)
14. [Лицензия](#лицензия)
15. [Используемые библиотеки / ассеты](#используемые-библиотеки--ассеты)

## Возможности
- Отображение текста с ролями, актёрами и цветовой дифференциацией, цвета раскраски актёров имеют более высокий приоритет над цветами из проекта.
- Фильтрация ролей и актёров (solo/mute) с мгновенным обновлением списка и сохранением состояния в настройках проекта.
- Обнаружение пересечений реплик: группы выделяются единой рамкой и полосой слева, доступны счётчики и тултипы, при наведении на группу отображается подсказка.
- Автопрокрутка в режимах «страница» и «строка», настраиваемая инерция и якорь активной реплики.
- Прыжок по клику и защитой от случайного клика при воспроизведении/записи; подсветка выполняется без автоскролла.
- Центрирование активной строки, подсветки текущей/прошлой/пауз, прогресс-бары по реплике или таймкоду.
- Масштаб интерфейса (UI Scale), адаптивная навигационная панель, компактный режим и полноэкранный просмотр.
- Мгновенная синхронизация заголовка проекта и статуса транспорта REAPER, плавающие контролы для управления.
- Режимы шахматной подложки (checkerboard) и кастомные шрифты для повышения читаемости.
- Работа во встроенном WebView и через браузер по локальной сети, поддержка крупных проектов (10k+ реплик).

## Скриншоты / Визуал
![Скриншот1](https://lostpix.com/img/2025-10/20/qvyh97c9tcfgrvarcg89b1bfi.png)

## Архитектура и компоненты
Проект состоит из двух основных частей:
1. Lua-скрипты (каталог `Scripts/`):
   - `FRZZ_web_prompter.lua` — точка запуска (frontend окно / подключение к WebView).
   - `FRZZ_web_prompter_backend.lua` — backend: обработка текста, ролей, взаимодействие с REAPER (ExtState / команды).
2. Web-интерфейс (каталог `reaper_www_root/`):
   - `prompter.html` — каркас страницы.
   - `script.js` — логика UI, синхронизация, отрисовка, прокрутка, подсветка.
   - `style.css` — оформление и адаптив.
   - `icons.svg` — набор иконок.
   - `jquery.min.js`, `spectrum.js`, `spectrum.css` — внешние зависимости (не модифицировать).
3. Дополнительно:
   - `UserPlugins/` — динамически подключаемая библиотека плагина `reaper_webview` (для встроенного режима) и `WebView2Loader.dll` (Windows).
   - `installer.py` — скрипт автоматической установки (копирование файлов + настройка действий + опциональная настройка веб-сервера в `reaper.ini`).

## Установка
### Быстрая установка через инсталлер
1. Скачайте релизный инсталлер (`.exe` на Windows / `.command` на macOS).
2. Запустите.
3. Подтвердите путь к папке ресурсов REAPER (обычно определяется автоматически).
4. Дождитесь копирования скриптов, web-ресурсов и плагина (если присутствует в сборке).
5. (Опционально) Согласитесь на автоматическое добавление web-интерфейса (HTTP) в `reaper.ini` — будет создан `csurf_*` блок.
6. Перезапустите REAPER.

После установки появятся два действия в Action List:
- `Custom: Web Prompter Backend`
- `Custom: Web Prompter Launch`

### Ручная установка
1. Скопируйте каталоги `Scripts/`, `reaper_www_root/` и (не нужно если запускаете только через браузер) `UserPlugins/` в папку ресурсов REAPER:
   - Windows: `%APPDATA%/REAPER`
   - macOS: `~/Library/Application Support/REAPER`
2. Добавьте строки действий в `reaper-kb.ini` (если не хотите запускать инсталлер):
```
SCR 4 0 FRZZ_WEB_NOTES_READER "Custom: Web Prompter Backend" FRZZ_web_prompter_backend.lua
SCR 4 0 FRZZ_NOTES_READER_LAUNCH "Custom: Web Prompter Launch" FRZZ_web_prompter.lua
```
3. Настройте веб-сервер в `reaper.ini` (параметры `csurf_cnt` и `csurf_*` с упоминанием `prompter.html`) либо в самом REAPER через "`Options` \ `Preferences` \ `Control/OSC/web`".
4. Перезапустите REAPER.

## Первый запуск
1. Выполните действие `Web Prompter Backend` (если backend не запускается автоматически из Launch).
2. Выполните `Web Prompter Launch` или откройте в браузере адрес вида `local_ip:port` (например `192.168.0.111:8080`) указанный в настройках `Control/OSC/web`.
3. Должно открыться окно со строками текста.
4. Проверьте корректность отображения ролей и подсветки.

## Режимы использования
### Встроенный WebView внутри REAPER
- Требует установленного расширения `reaper_webview` (идёт в комплекте или ставится отдельно).
- Окно открывается внутри REAPER, не требуя внешний браузер.

### Открытие в браузере по сети
1. Убедитесь, что в `reaper.ini` настроен HTTP csurf для `prompter.html`.
2. Откройте адрес `http://localhost:PORT` или `http://LAN_IP:PORT` (IP локальной машины).
3. Интерфейс идентичен встроенному, при активном backend обновления поступают синхронно.

## Настройки и поведение
### Основные параметры
- **Размер и геометрия**: UI Scale, шрифты, межстрочный интервал, отступы, ширина колонки ролей.
- **Прокрутка**: выбор режима автоскролла (страница/строка), скорость, инерция, окно удержания, блокировка во время прыжка.
- **Подсветки**: отдельные тогглы для текущей, предыдущей, пауз, прогресс-бара и групп пересечений.
- **Транспорт**: отображение таймкода, позиция прогресс-бара, полноэкранный режим, компактная панель.
- **Jump**: включение прыжка по клику, величина пре-ролла, запрет во время воспроизведения или записи.
- **Фильтры**: solo/mute для актёров, фильтр по ролям, сохранение выбранных комбинаций.

### Цветовая модель ролей и актёров
- Цвет актёра всегда перекрывает цвет строки и хранится вместе с настройками проекта.
- Отображение использует memo-индексы, чтобы фильтры и подсветки не дублировали данные и не нагружали DOM.
- Все изменения синхронизируются через backend (chunked JSON) и автоматически восстанавливаются при загрузке проекта.

### Дополнительные режимы
- **Checkerboard**: отключен / по ролям / по уникальным цветам ролей.
- **Dim фильтр**: временно скрывает или затемняет неактуальные строки в комбинации с фильтрами.
- **Мобильный профиль**: автоматическая адаптация под планшеты, плавающие кнопки управления.

## Структура репозитория
```
Scripts/                    # Lua backend и launch скрипты
reaper_www_root/            # Веб-интерфейс (HTML/JS/CSS + внешние библиотеки)
UserPlugins/                # Плагин reaper_webview и зависимости (опционально для релизов)
installer.py                # Автоматический установщик
KeyMaps/                    # (Если есть преднастроенные keymap файлы)
README.md                   # Этот файл
LICENSE                     # MIT лицензия
```

## Обновление
1. Скачайте новую версию (инсталлер или архив).
2. Поверх скопируйте `Scripts/`, `reaper_www_root/`, при необходимости обновите `UserPlugins/` или запустите инсталлятор.
3. Перезапустите REAPER.
4. Настройки (цвета, роли) сохранятся автоматически (persist через ExtState / JSON).

## Известные ограничения
- Нет встроенного редактирования текста «на лету» (редактирование через исходные данные проекта / внешние файлы).
- Нет пока импорта форматов субтитров (.srt, .ass) — в планах.
- Требуется стабильный WebView движок (на Windows — WebView2 Runtime) для встроенного режима.

## Roadmap (кратко)
- Поддержка импорта субтитров через интерфейс текстового монитора (srt / ass)
- Продвинутые статистики / отчёты
- Расширение функционала
- Добавление пресетов
- Более глубокая интеграция с REAPER

## Отладка и диагностика
- При проблемах с отображением убедитесь, что backend запущен.
- Проверяйте наличие записи о `prompter.html` в `reaper.ini` (csurf_* строки).
- В случае артефактов раскраски — перезапустите окно (закрыть/открыть Launch script).
- Если не обновляется название проекта — сохраните проект в REAPER (формирование имени).
- Для встроенного режима: проверьте загрузку `reaper_webview` в меню Extensions.

## Частые вопросы
**Q:** Окно пустое. Что делать?  
**A:** Запустите действие `Web Prompter Backend` и убедитесь, что веб-сервер REAPER активен (строка `csurf_*` с `prompter.html` в `reaper.ini`). Текстовый монитор не читает SWS Notes и маркеры — нужны подготовленные субтитры. Либо перезапустите сервер в Reaper через "`Options` \ `Preferences` \ `Control/OSC/web`".

**Q:** Клик по строке не перемещает позицию транспорта.  
**A:** Проверьте настройку «Jump по клику» в модалке. Если она включена, убедитесь, что не активно воспроизведение/запись (при соответствующих активированных защитах) и указан корректный пре-ролл.

**Q:** Как выглядит подсветка пересечений?  
**A:** Пересекающиеся реплики объединяются в блок с общей рамкой и левой полосой. В подсказке — диапазон и длительность пересечения.

**Q:** Где хранятся настройки и фильтры?  
**A:** Глобальные настройки — в `reaper_www_root/settings.json`. Проектные данные (роли, актёры, фильтры) сохраняются рядом с проектом: `<project>-roles.json`.

**Q:** Можно ли открыть интерактивную монтажку на планшете?  
**A:** Да. Настройте HTTP csurf (если не сделали этого ранее), откройте адрес `http://<ip>:<port>` (адрес внутри локальной сети можно посмотреть в настройках рипера) — UI адаптируется под мобильный профиль и предоставляет плавающие кнопки.

**Q:** Встроенный режим не запускается на Windows 7/8.x.  
**A:** Установите Microsoft Edge WebView2 Runtime со страницы [developer.microsoft.com](https://developer.microsoft.com/en-us/microsoft-edge/webview2). Без него встроенный WebView не инициализируется.

## Лицензия
MIT License — см. файл `LICENSE`.

## Используемые библиотеки / ассеты
- jQuery
- Spectrum Color Picker
- SVG Repo Solar Bold Icons Collection