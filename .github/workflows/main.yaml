# –ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å–µ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ (Workflow)
name: Build Python Installer

# –¢—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∑–∞–ø—É—Å–∫–∞: —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –ø—Ä–∏ –ª—é–±–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ (push) –∫–æ–¥–∞ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
on: [push]

jobs:
  build:
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–±–æ—Ä–∫—É –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –Ω–∞ –¥–≤—É—Ö –æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Å–∏—Å—Ç–µ–º–∞—Ö
    strategy:
      matrix:
        os: [windows-latest, macos-latest]

    # –£–∫–∞–∑—ã–≤–∞–µ–º, –∫–∞–∫—É—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ–∫—É—â–µ–π –∑–∞–¥–∞—á–∏
    runs-on: ${{ matrix.os }}

    steps:
    # –®–∞–≥ 1: –°–∫–∞—á–∏–≤–∞–µ–º –∫–æ–¥ –∏–∑ –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é –º–∞—à–∏–Ω—É
    - name: Checkout repository
      uses: actions/checkout@v4

    # --- üëá –ù–û–í–´–ô –®–ê–ì üëá ---
    # –®–∞–≥ 2: –ò–∑–≤–ª–µ–∫–∞–µ–º –≤–µ—Ä—Å–∏—é –∏–∑ HTML –∏ –∑–∞–¥–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    - name: Extract Version and Set Env Vars
      id: extract_version
      shell: bash
      run: |
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ç–µ–≥–∞ <title>, –Ω–∞–ø—Ä–∏–º–µ—Ä "My Prompter v1.2.3"
        TITLE=$(sed -n 's|.*<title>\(.*\)</title>.*|\1|p' reaper_www_root/prompter.html | xargs)
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º –∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏—é, –Ω–∞–ø—Ä–∏–º–µ—Ä "v1.2.3"
        # –ï—Å–ª–∏ –≤–µ—Ä—Å–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º "unknown"
        VERSION=$(echo "$TITLE" | grep -o 'v[0-9.]*' || echo "unknown")
        
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è –û–°
        OS_NAME=""
        if [ "${{ runner.os }}" == "Windows" ]; then
          OS_NAME="win"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          OS_NAME="mac"
        fi
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø–æ—Å–ª–µ–¥—É—é—â–∏—Ö —à–∞–≥–∞—Ö
        echo "PROMPTER_VERSION=$VERSION" >> $GITHUB_ENV
        echo "OS_NAME=$OS_NAME" >> $GITHUB_ENV
        echo "Final filename: FRZZ-reaper-web-prompter-$VERSION-$OS_NAME"


    # –®–∞–≥ 3: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–∂–Ω—É—é –≤–µ—Ä—Å–∏—é Python
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    # –®–∞–≥ 4: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º PyInstaller
    - name: Install PyInstaller
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller

    # --- üëá –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –®–ê–ì üëá ---
    # –®–∞–≥ 5: –°–æ–±–∏—Ä–∞–µ–º .exe –¥–ª—è Windows —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º
    - name: Build for Windows
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller `
          --name "FRZZ-reaper-web-prompter-${{ env.PROMPTER_VERSION }}-${{ env.OS_NAME }}" `
          --onefile `
          --clean `
          --add-data "Scripts;Scripts" `
          --add-data "reaper_www_root;reaper_www_root" `
          installer.py

    # --- üëá –ò–ó–ú–ï–ù–ï–ù–ù–´–ô –®–ê–ì üëá ---
    # –®–∞–≥ 6: –°–æ–±–∏—Ä–∞–µ–º –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª –¥–ª—è macOS —Å –Ω–æ–≤—ã–º –∏–º–µ–Ω–µ–º
    - name: Build for macOS
      if: matrix.os == 'macos-latest'
      run: |
        pyinstaller \
          --name "FRZZ-reaper-web-prompter-${{ env.PROMPTER_VERSION }}-${{ env.OS_NAME }}" \
          --onefile \
          --clean \
          --add-data "Scripts:Scripts" \
          --add-data "reaper_www_root:reaper_www_root" \
          installer.py

    # –®–∞–≥ 7: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∫–∞–∫ "–∞—Ä—Ç–µ—Ñ–∞–∫—Ç" —Å–±–æ—Ä–∫–∏
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        # –ê—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –±—É–¥—É—Ç –Ω–∞–∑–≤–∞–Ω—ã, –Ω–∞–ø—Ä–∏–º–µ—Ä, "installer-builds"
        name: installer-builds
        path: dist/