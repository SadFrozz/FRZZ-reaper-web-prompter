name: Build Python Installer

on: [push]

jobs:
  build:
    strategy:
      matrix:
        os: [windows-latest, macos-latest]

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract Version and Set Env Vars
      id: extract_version
      shell: bash
      run: |
        TITLE=$(sed -n 's|.*<title>\(.*\)</title>.*|\1|p' reaper_www_root/prompter.html | xargs)
        VERSION=$(echo "$TITLE" | grep -o 'v[0-9.]*' || echo "unknown")
        OS_NAME=""
        if [ "${{ runner.os }}" == "Windows" ]; then
          OS_NAME="win"
        elif [ "${{ runner.os }}" == "macOS" ]; then
          OS_NAME="mac"
        fi
        echo "PROMPTER_VERSION=$VERSION" >> $GITHUB_ENV
        echo "OS_NAME=$OS_NAME" >> $GITHUB_ENV
        echo "Version extracted: $VERSION"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install PyInstaller
      run: python -m pip install --upgrade pip && pip install pyinstaller

    # --- –°–ë–û–†–ö–ê –î–õ–Ø WINDOWS (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ---
    - name: Build Windows Executable
      if: matrix.os == 'windows-latest'
      run: |
        pyinstaller `
          --name "FRZZ-reaper-web-prompter-${{ env.PROMPTER_VERSION }}-${{ env.OS_NAME }}" `
          --onefile --clean `
          --add-data "Scripts;Scripts" `
          --add-data "reaper_www_root;reaper_www_root" `
          installer.py

    # --- üëá –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ü–†–û–¶–ï–°–° –°–ë–û–†–ö–ò –î–õ–Ø MACOS üëá ---
    - name: Build macOS Core Executable
      if: matrix.os == 'macos-latest'
      run: |
        # –®–∞–≥ 1: –°–æ–±–∏—Ä–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç –∫–∞–∫ –ö–û–ù–°–û–õ–¨–ù–û–ï –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º
        pyinstaller \
          --name "installer_logic" \
          --onefile --console \
          --add-data "Scripts:Scripts" \
          --add-data "reaper_www_root:reaper_www_root" \
          installer.py

    - name: Create macOS .app Bundle
      if: matrix.os == 'macos-latest'
      run: |
        # –®–∞–≥ 2: –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É .app –∏ —É–ø–∞–∫–æ–≤—ã–≤–∞–µ–º –≤ –Ω–µ–µ –Ω–∞—à –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–π —Ñ–∞–π–ª
        APP_NAME="FRZZ-reaper-web-prompter-${{ env.PROMPTER_VERSION }}-${{ env.OS_NAME }}.app"
        
        echo "Creating .app structure for $APP_NAME"
        mkdir -p "$APP_NAME/Contents/MacOS"
        mkdir -p "$APP_NAME/Contents/Resources"
        
        echo "Moving Python executable into the bundle"
        mv "dist/installer_logic" "$APP_NAME/Contents/MacOS/"
        
        echo "Creating launcher script"
        cat << EOF > "$APP_NAME/Contents/MacOS/launcher"
        #!/bin/bash
        DIR=\$(dirname "\$0")
        open -a Terminal "\$DIR/installer_logic"
        EOF
        chmod +x "$APP_NAME/Contents/MacOS/launcher"
        
        echo "Creating Info.plist"
        cat << EOF > "$APP_NAME/Contents/Info.plist"
        <?xml version="1.0" encoding="UTF-8"?>
        <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
        <plist version="1.0">
        <dict>
            <key>CFBundleExecutable</key>
            <string>launcher</string>
            <key>CFBundleIdentifier</key>
            <string>com.frzz.reaperwebprompter.installer</string>
            <key>CFBundleName</key>
            <string>FRZZ Reaper Web Prompter Installer</string>
            <key>CFBundlePackageType</key>
            <string>APPL</string>
            <key>CFBundleShortVersionString</key>
            <string>${{ env.PROMPTER_VERSION }}</string>
        </dict>
        </plist>
        EOF
        
        echo "Compressing .app into a .zip for upload"
        zip -r "${APP_NAME}.zip" "$APP_NAME"

    # --- üëá –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –®–ê–ì –ó–ê–ì–†–£–ó–ö–ò –ê–†–¢–ï–§–ê–ö–¢–û–í üëá ---
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: installer-${{ matrix.os }}
        # –î–ª—è Windows –∑–∞–≥—Ä—É–∂–∞–µ–º .exe, –¥–ª—è macOS - .zip –∞—Ä—Ö–∏–≤ —Å .app –≤–Ω—É—Ç—Ä–∏
        path: |
          dist/*.exe
          *.app.zip